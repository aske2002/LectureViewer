FROM nvidia/cuda:12.4.1-devel-ubuntu22.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /app

RUN apt-get update && apt-get install -y \
    curl git ffmpeg build-essential cmake ninja-build \
 && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
 && apt-get install -y nodejs \
 && npm install -g yarn \
 && rm -rf /var/lib/apt/lists/*

RUN npm install -g yarn

RUN git clone https://github.com/ggerganov/whisper.cpp && \
    cd whisper.cpp && \
    cmake -B build -DGGML_CUDA=ON && \
    cmake --build build -j && \
    cp build/bin/whisper-cli /app/whisper-gpu

COPY package.json yarn.lock* ./
RUN yarn install

COPY . .
RUN yarn build



FROM nvidia/cuda:12.4.1-runtime-ubuntu22.04

WORKDIR /app
RUN apt-get update && apt-get install -y ffmpeg && rm -rf /var/lib/apt/lists/*

COPY --from=builder /app/whisper-gpu ./whisper
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/models ./models

CMD ["node", "dist/server.js"]
